---
title: "Tomo mouse NSC bulk RNAseq profiling"
subtitle: "DESeq2 (Modular & Reproducible Analysis)"
author: "Ryan Miller"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: show
    theme: journal
---

### Project Setup
This document runs a full differential expression analysis pipeline. The modular scripts are stored in a `./scripts/` subdirectory.

<hr>

### R Setup and Global Variables

#### Package Installation and Libraries
This chunk sources the setup script to install any missing packages. Then it loads the core libraries for the main document.
```{r setup, message=TRUE, warning=FALSE}
# Source the setup script to ensure a reproducible environment
source("./scripts/00_setup.R")

# Load libraries needed for the main Rmd file
library("tidyverse")
library("rmarkdown")
library("reactable")
library("RColorBrewer")
```

#### Define Directories and Parameters
Global parameters for the analysis are defined here. Child scripts will inherit these.
```{r global_vars}
# Output directories
dir_output <- "./output/"
dir_graph <- "./graphs/"
dir.create(dir_output, showWarnings = FALSE, recursive = TRUE)
dir.create(dir_graph, showWarnings = FALSE, recursive = TRUE)

# DESeq2 parameters
pval <- 0.05
qval <- 0.05
lfc <- 1
filt <- 20 # Low read count filter cutoff

# Other variables
date <- format(Sys.Date(), format = "%Y%m%d")
nc <- BiocParallel::multicoreWorkers()
set.seed(888)

# GOI
project_genes <- c("Egfr", "Pdgfra", "Pten", "Cdkn2a")
```

#### DESeq2 Model Design
Define the statistical models that will be used for the analysis.
```{r model_design}
# Variables for the DESeq2 model design
vars <- c("Type", "Host", "Driver")
vars_int <- c("Host*Driver", "Host*Type", "Driver*Type")
var4 <- "SeqBatch"

# Create a named list of design formulas
design_list <- list(
  model_1 = as.formula(paste("~", paste(vars, collapse = " + "))),
  model_2 = as.formula(paste("~", paste(var4, paste(vars_int, collapse = " + "), sep = " + ")))
)
print("Models to be used in the analysis:")
print(design_list)
```
### Genesets
```{r}
#### Kinases
file_kinases <- "./genesets/201006_composite_kinases.csv"
if (file.exists(file_kinases)) {
  kinases <- read.csv(file_kinases, header = TRUE, fileEncoding = "UTF-8-BOM")
} else {
  stop(paste("File not found:", file_kinases))
}
str(kinases)
head(kinases)
kinase_genes <- kinases$Mouse_symbol
```

<hr>

### Analysis Pipeline
This section sources the external R scripts that perform the analysis. Each script is run in the global environment to ensure it can access and modify shared data objects.

#### 1. Load Inputs
```{r run_inputs, echo=TRUE}
source("./scripts/01_inputs.R", local = knitr::knit_global())
```

#### 2. Prepare Data
```{r run_data_prep, echo=TRUE}
source("./scripts/02_data_prep.R", local = knitr::knit_global())
```

#### 1A. Graph Annotations and Colors
```{r}
anno_vars <- c("Type", "Host", "Driver")
anno <- as.data.frame(samples[, anno_vars])
summarized_anno <- anno %>%
  group_by(across(all_of(anno_vars))) %>%
  summarize(n = n(), .groups = "drop")
# Display as an interactive table
reactable(
  summarized_anno,
  searchable = TRUE,
  filterable = TRUE,
  resizable = TRUE
)

# Get unique entries for each variable
unique_values_by_var <- lapply(anno, unique)
unique_values_by_var

anno_colors <- list(
  Host = c("NSG" = "gray", "BL6" = "black"),
  Driver = c(
    "EGFRvIII" = "blue",
    "EGFRvV" = "dodgerblue",
    "PDGFRA" = "red"
  ),
  Type = c(
    "NS1" = "lightgray",
    "NS2" = "darkgray",
    "GBO" = "black",
    "Tumor" = "purple"
  )
)
```

#### 3. Quality Control
```{r run_qc, echo=TRUE}
source("./scripts/03_QC.R", local = knitr::knit_global())
```

#### 4. Differential Expression Analysis
```{r run_deseq, echo=TRUE}
source("./scripts/04_DESeq.R", local = knitr::knit_global())
```